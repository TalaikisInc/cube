worker_processes 1;

events { worker_connections 1024; }

http {
    sendfile on;
    server_tokens off;
    access_log off;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://ssl.google-analytics.com; img-src 'self' https://ssl.google-analytics.com https://s-static.ak.facebook.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://themes.googleusercontent.com; frame-src https://www.facebook.com https://s-static.ak.facebook.com; object-src 'none'";
    add_header X-Download-Options noopen;
    add_header Referrer-Policy no-referrer;

    client_body_buffer_size     10K;
    client_header_buffer_size   1k;
    client_max_body_size        8m;
    large_client_header_buffers 2 1k;
    client_body_timeout         12;
    client_header_timeout       12;
    keepalive_timeout           5;
    send_timeout                10;

    upstream identiform {
        server 127.0.0.1:3000 fail_timeout=0;
    }

    upstream mail {
        server 127.0.0.1:3001 fail_timeout=0;
    }

    server {
        listen 80;
        listen [::]:80;

        server_name identiform.com;

        location ^~ /.well-known {
            allow all;
            auth_basic off;
            alias /var/www/letsencrypt/;
        }

        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    server {
        listen 80;
        listen [::]:80;

        server_name mail.identiform.com;

        location ^~ /.well-known {
            allow all;
            auth_basic off;
            alias /var/www/letsencrypt/;
        }

        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        server_name identiform.com;

        ssl_certificate /etc/letsencrypt/live/identiform.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/identiform.com/privkey.pem;

        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH RSA+AESGCM RSA+AES !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS";
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://identiform;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Referer $http_referer;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;

            add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
        }
    }

    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        server_name mail.identiform.com;

        ssl_certificate /etc/letsencrypt/live/mail.identiform.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/mail.identiform.com/privkey.pem;

        ssl_session_cache shared:SSL:50m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH RSA+AESGCM RSA+AES !RC4 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS";
        ssl_prefer_server_ciphers on;

        location / {
            proxy_pass http://mail;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Referer $http_referer;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Host $server_name;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;

            add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
        }
    }
}

# include /etc/nginx/bots.d/ddos.conf;
# include /etc/nginx/bots.d/blockbots.conf;
